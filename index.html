<!doctype html>
<html>

<head>
  <title>Tron wanna-be</title>
  <style>
    body {
      overflow: hidden;
    }

    canvas {
      border: 2px solid black;
    }
  </style>
</head>

<body>
  <script type="application/javascript">
    (function () {
      var lastTime = 0;
      var vendors = ['ms', 'moz', 'webkit', 'o'];
      for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
        window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame']
          || window[vendors[x] + 'CancelRequestAnimationFrame'];
      }

      if (!window.requestAnimationFrame)
        window.requestAnimationFrame = function (callback, element) {
          var currTime = new Date().getTime();
          var timeToCall = Math.max(0, 16 - (currTime - lastTime));
          var id = window.setTimeout(function () { callback(currTime + timeToCall); },
            timeToCall);
          lastTime = currTime + timeToCall;
          return id;
        };

      if (!window.cancelAnimationFrame)
        window.cancelAnimationFrame = function (id) {
          clearTimeout(id);
        };
    }());
  </script>
  <script type="application/javascript" src="/socket.io/socket.io.js"></script>
  <script type="application/javascript">
    Renderer = (function () {
      function Renderer(canvas) {
        var ratio = window.innerWidth < window.innerHeight ?
          window.innerWidth - 20 : window.innerHeight - 20;
        this.canvas = canvas;
        this.canvas.width = this.canvas.height = ratio;
        this.context = this.canvas.getContext('2d');
        this.gridSize = 100;
        this.cellSize = ratio / this.gridSize;
      }

      Renderer.prototype.draw = function (state) {
        var context = this.context;
        var cellSize = this.cellSize;

        this.context.fillStyle = "#fff";
        this.context.fillRect(0, 0, this.canvas.width, this.canvas.height);

        if (state.state == 'idle') {
          context.font = "30px Arial";
          context.fillStyle = 'Black';
          context.textAlign = 'center';
          context.fillText("Waiting...", this.canvas.width / 2, this.canvas.height / 2);
        }
        else if (state.state == 'preparing') {
          context.font = "30px Arial";
          context.fillStyle = 'Black';
          context.textAlign = 'center';
          context.fillText("Get ready!", this.canvas.width / 2, this.canvas.height / 2);
        }

        state.players.forEach((p) => {
          context.fillStyle = p.color;
          context.fillRect(p.x * cellSize, p.y * cellSize, cellSize, cellSize);
        });

        state.obstacles.forEach((o) => {
          context.fillStyle = o.color;
          context.fillRect(o.x * cellSize, o.y * cellSize, cellSize, cellSize);
        });
      }

      return Renderer;
    })();

    var socket = io();

    var canvas = document.createElement("canvas");
    document.body.appendChild(canvas);

    var renderer = new Renderer(canvas);

    document.onkeydown = (ev) => {
      socket.emit('key', ev.keyCode);
    };

    // todo separate getting data and drawing
    socket.on('state', (data) => {
      console.log(data.state);
      console.log(data.players);
      renderer.draw(data);
    });

  </script>
</body>

</html>
